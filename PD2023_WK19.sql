-- BEGINNER LEVEL
CREATE OR REPLACE TEMPORARY VIEW PD2023_W19_OUTPUT1 AS(
SELECT SUBJECT, SPEAKER, SESSION_NUMBER, DEDUPLICATION_FLAG FROM(
SELECT
    *,
    ARRAY_TO_STRING(
    REGEXP_SUBSTR_ALL(
    REPLACE(SPLIT(DESCRIPTION, ':') [0], '""', ''), '[A-Z]'
    ), '')AS SPEAKER,
    REPLACE(SPLIT(DESCRIPTION, ':') [0], '""', '') AS SPEAKER_NAME,
    SPLIT(DESCRIPTION, ':') [1] AS TOPIC, 
    CASE WHEN ILIKE(TOPIC, '%server%') THEN 'Server' WHEN ILIKE(TOPIC, '%community%') THEN 'Community' WHEN ILIKE(TOPIC, '%prep%') THEN 'Prep' ELSE 'Desktop' END AS SUBJECT,
    ILIKE(TOPIC, '%deduplication%') AS DEDUPLICATION_FLAG
FROM
    TIL_PLAYGROUND.PREPPIN_DATA_INPUTS.PD2023_WK19
) WHERE DEDUPLICATION_FLAG = TRUE);


-- INTERMEDIATE LEVEL
CREATE OR REPLACE TEMPORARY TABLE PD2023_WK19_ROOM(
    ROOM NUMBER,
    FLOOR_1 VARCHAR(255),
    FLOOR_2 VARCHAR(255),
    FLOOR_3 VARCHAR(255)
);

INSERT INTO PD2023_WK19_ROOM(ROOM, FLOOR_1, FLOOR_2, FLOOR_3)VALUES
    (1, 'Servicing Server - AP on Server', 'Preparing Prep - TP on Prep', 'Stats, stats, stats - RV on Desktop'),
    (2, 'Preppin\' Power - JM on Prep', 'Severe Server - JM on Server', 'Executive Track - TB on Community'),
    (3, 'Desktop Design - EB on Desktop', 'Fluffy Cloud - LK on Server', NULL),
    (4, 'Commit to the Community - TP on Community', 'Data, data everywhere but not able to analyse - CA on Prep', NULL),
    (5, 'Upping Performance - TN on Desktop', 'Awesome Analysis - RM on Desktop', NULL);
    
SELECT * FROM PD2023_WK19_ROOM;

-- JOINING RESULT FROM PART 1: BEGINNER LEVEL
CREATE OR REPLACE TEMPORARY VIEW PD2023_W19_OUTPUT2 AS(
SELECT t1.SPEAKER, t1.SUBJECT, SESSION_NUMBER, ROOM FROM(
SELECT
    * exclude (ROOM, FLOOR_NUM, TOPIC),
    TRIM(REPLACE(SPLIT(TOPIC, '-')[0], '""', '')) AS SESSION_NAME,
    TRIM(LEFT(SPLIT(TOPIC, '-')[1],3)) AS SPEAKER,
    REPLACE(SPLIT(SPLIT(TOPIC, '-')[1], ' on ')[1], '"', '') AS SUBJECT,
    CONCAT(
        RIGHT(FLOOR_NUM, 1),
        '0',
        ROOM::VARCHAR) AS ROOM
    FROM
        PD2023_WK19_ROOM UNPIVOT(
            TOPIC FOR FLOOR_NUM IN (FLOOR_1, FLOOR_2, FLOOR_3)
    )
) AS t2 JOIN PD2023_W19_OUTPUT1 AS t1 ON t1.SUBJECT = t2.SUBJECT AND t1.SPEAKER = t2.SPEAKER WHERE LEFT(ROOM,1)='2'
);


-- ADVANCED LEVEL
CREATE OR REPLACE TEMPORARY TABLE PD2023_WK19_ROOM_DIST(
    ROOM NUMBER,
    "101" NUMBER,
    "102" NUMBER,
    "103" NUMBER,
    "104" NUMBER,
    "105" NUMBER,
    "201" NUMBER,
    "202" NUMBER,
    "203" NUMBER,
    "204" NUMBER,
    "205" NUMBER,
    "301" NUMBER,
    "302" NUMBER
);

INSERT INTO PD2023_WK19_ROOM_DIST(ROOM, "101", "102", "103", "104", "105", "201", "202", "203", "204", "205", "301", "302") VALUES
(101, 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
(102, 319, 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
(103, 81, 155, 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
(104, 176, 125, 294, 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
(105, 223, 99, 159, 114, 0, NULL, NULL, NULL, NULL, NULL, NULL, NULL),
(201, 643, 635, 511, 398, 167, 0, NULL, NULL, NULL, NULL, NULL, NULL),
(202, 400, 453, 501, 574, 178, 119, 0, NULL, NULL, NULL, NULL, NULL),
(203, 700, 689, 418, 423, 99, 199, 281, 0, NULL, NULL, NULL, NULL),
(204, 690, 381, 533, 399, 291, 148, 287, 315, 0, NULL, NULL, NULL),
(205, 538, 662, 467, 556, 108, 201, 187, 256, 309, 0, NULL, NULL),
(301, 1106, 1351, 1021, 1139, 571, 700, 562, 559, 671, 605, 0, NULL),
(302, 1126, 1232, 1092, 1014, 478, 668, 703, 663, 699, 708, 140, 0);

SELECT * exclude (ROOM, SESSION_NUMBER), CEIL(DIST/1.2/60) AS "MINUTES TO THE NEXT ROOM" FROM(
SELECT
    ROOM AS ROOM_A,
    * exclude ROOM
FROM
    PD2023_WK19_ROOM_DIST UNPIVOT(
        DIST FOR ROOM_B IN (
            "101",
            "102",
            "103",
            "104",
            "105",
            "201",
            "202",
            "203",
            "204",
            "205",
            "301",
            "302"
        )
    ) WHERE DIST != 0
) AS t3 JOIN PD2023_W19_OUTPUT2 AS t2 ON t2.ROOM = t3.ROOM_B WHERE ROOM_A = '302';