SELECT *, DENSE_RANK() OVER (PARTITION BY GRADE ORDER BY SUBJECT) AS SCORE_RANK FROM(
SELECT AVG(ENGLISH) AS ENG, AVG(ECONOMICS) AS ECO, AVG(PSYCHOLOGY) AS PSY, CLASS FROM TIL_PLAYGROUND.PREPPIN_DATA_INPUTS.PD2023_WK23_RESULTS AS R JOIN TIL_PLAYGROUND.PREPPIN_DATA_INPUTS.PD2023_WK23_STUDENT_INFO AS I ON R.STUDENT_ID = I.X_STUDENT_ID GROUP BY CLASS
)UNPIVOT(SUBJECT FOR GRADE IN (ENG, ECO, PSY)) QUALIFY SCORE_RANK = 1 ORDER BY SUBJECT DESC; 